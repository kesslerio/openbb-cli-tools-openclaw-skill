#!/usr/bin/env bash
# OpenBB financial statements tool
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
# shellcheck source=/dev/null
source "$SCRIPT_DIR/_openbb_common.sh"


if [ $# -lt 1 ]; then
    echo "Usage: openbb-financials SYMBOL [statement] [years]"
    exit 1
fi

SYMBOL="$1"
STATEMENT="${2:-income}"
YEARS="${3:-5}"
PROVIDER="$(resolve_openbb_provider "" "yfinance")"

run_openbb_python_with_retry << PYSCRIPT
import os
import sys
import json
from openbb import obb

symbol = "$SYMBOL"
statement = "$STATEMENT"
years = int("$YEARS")

def safe_get(obj, attr, default=None):
    if obj is None:
        return default
    # First check direct attribute
    val = getattr(obj, attr, None)
    if val is not None:
        return val
    # Then check model_extra
    if hasattr(obj, 'model_extra') and obj.model_extra:
        return obj.model_extra.get(attr, default)
    return default

def calc_yoy(current, prior):
    if current and prior and prior != 0:
        return (current - abs(prior)) / abs(prior)
    return None

def safe_round(value, decimals=4):
    """Round value if not None, otherwise return None"""
    if value is not None:
        return round(value, decimals)
    return None

def process_income(data):
    if not data or not data.results:
        return None
    periods = []
    revenues = []
    net_incomes = []
    for item in data.results:
        period = {
            "date": str(safe_get(item, 'period_ending', '')),
            "revenue": safe_get(item, 'total_revenue'),
            "gross_profit": safe_get(item, 'gross_profit'),
            "operating_income": safe_get(item, 'operating_income'),
            "net_income": safe_get(item, 'net_income'),
            "eps_diluted": safe_get(item, 'diluted_earnings_per_share'),
        }
        if period['revenue'] and period['revenue'] > 0:
            if period['gross_profit']:
                period['gross_margin'] = safe_round(period['gross_profit'] / period['revenue'])
            if period['net_income']:
                period['net_margin'] = safe_round(period['net_income'] / period['revenue'])
        periods.append(period)
        revenues.append(period['revenue'])
        net_incomes.append(period['net_income'])
    for i in range(len(periods) - 1):
        periods[i]['revenue_yoy'] = safe_round(calc_yoy(revenues[i], revenues[i+1]))
        periods[i]['net_income_yoy'] = safe_round(calc_yoy(net_incomes[i], net_incomes[i+1]))
    return {"periods": periods}

def process_cash_flow(data, income_data=None):
    """Process cash flow statement data, optionally using income data for margin calculations."""
    if not data or not data.results:
        return None
    
    # Build revenue lookup from income data if available
    revenue_by_date = {}
    if income_data and income_data.results:
        for item in income_data.results:
            date_str = str(safe_get(item, 'period_ending', ''))
            revenue = safe_get(item, 'total_revenue')
            if date_str and revenue:
                revenue_by_date[date_str] = revenue
    
    periods = []
    for item in data.results:
        date_str = str(safe_get(item, 'period_ending', ''))
        
        # Get cash flow values from model_extra (where yfinance stores them)
        extra = getattr(item, 'model_extra', {}) or {}
        
        operating_cf = extra.get('operating_cash_flow')
        capex = extra.get('capital_expenditure')
        fcf = extra.get('free_cash_flow')
        sbc = extra.get('stock_based_compensation')
        
        # Calculate FCF if not directly available
        if fcf is None and operating_cf is not None and capex is not None:
            fcf = operating_cf + capex  # capex is typically negative
        
        period = {
            "date": date_str,
            "operating_cash_flow": operating_cf,
            "capital_expenditure": capex,
            "free_cash_flow": fcf,
            "stock_based_compensation": sbc,
        }
        
        # Calculate margins if we have revenue
        revenue = revenue_by_date.get(date_str)
        if revenue and revenue > 0:
            period['revenue'] = revenue
            if fcf is not None:
                period['fcf_margin'] = safe_round(fcf / revenue)
            if sbc is not None:
                period['sbc_percent_revenue'] = safe_round(sbc / revenue)
            if fcf is not None and sbc is not None:
                period['dilution_adj_fcf_margin'] = safe_round((fcf - sbc) / revenue)
        
        periods.append(period)
    
    return {"periods": periods}

def process_balance_sheet(data):
    """Process balance sheet data with key financial health metrics."""
    if not data or not data.results:
        return None
    
    periods = []
    for item in data.results:
        date_str = str(safe_get(item, 'period_ending', ''))
        extra = getattr(item, 'model_extra', {}) or {}
        
        # Core balance sheet items
        period = {
            "date": date_str,
            # Assets
            "cash_and_equivalents": extra.get('cash_and_cash_equivalents'),
            "short_term_investments": extra.get('short_term_investments'),
            "total_current_assets": extra.get('total_current_assets'),
            "total_non_current_assets": extra.get('total_non_current_assets'),
            "total_assets": extra.get('total_assets'),
            # Liabilities
            "total_current_liabilities": extra.get('current_liabilities'),
            "total_non_current_liabilities": extra.get('total_non_current_liabilities_net_minority_interest'),
            "total_liabilities": extra.get('total_liabilities_net_minority_interest'),
            # Equity
            "total_equity": extra.get('total_common_equity'),
            "retained_earnings": extra.get('retained_earnings'),
            # Debt
            "total_debt": extra.get('total_debt'),
            "long_term_debt": extra.get('long_term_debt'),
            "net_debt": extra.get('net_debt'),
            # Shares
            "shares_outstanding": extra.get('ordinary_shares_number'),
        }
        
        # Calculate key ratios
        total_assets = period['total_assets']
        total_equity = period['total_equity']
        total_liabilities = period['total_liabilities']
        current_assets = period['total_current_assets']
        current_liabilities = period['total_current_liabilities']
        
        if total_assets and total_assets > 0:
            # Asset composition
            if period['cash_and_equivalents'] is not None:
                period['cash_to_assets'] = safe_round(period['cash_and_equivalents'] / total_assets)
            if total_equity is not None:
                period['equity_to_assets'] = safe_round(total_equity / total_assets)
            if total_liabilities is not None:
                period['liabilities_to_assets'] = safe_round(total_liabilities / total_assets)

        # Liquidity ratios
        if current_liabilities and current_liabilities > 0:
            if current_assets is not None:
                period['current_ratio'] = safe_round(current_assets / current_liabilities)
            cash = period['cash_and_equivalents'] or 0
            if period['short_term_investments'] is not None:
                cash += period['short_term_investments']
            period['cash_ratio'] = safe_round(cash / current_liabilities)

        # Leverage ratios
        if total_equity and total_equity > 0:
            if period['total_debt'] is not None:
                period['debt_to_equity'] = safe_round(period['total_debt'] / total_equity)
            if total_liabilities is not None:
                period['liabilities_to_equity'] = safe_round(total_liabilities / total_equity)
        
        periods.append(period)
    
    return {"periods": periods}

try:
    output = {"symbol": symbol, "statement": statement}
    income_data = None
    
    if statement in ['income', 'all', 'cash', 'balance']:
        # Always fetch income for revenue (needed for margin calculations)
        income_data = obb.equity.fundamental.income(symbol=symbol, provider='$PROVIDER', limit=years)
        if statement in ['income', 'all']:
            output['income'] = process_income(income_data)
    
    if statement in ['balance', 'all']:
        balance_data = obb.equity.fundamental.balance(symbol=symbol, provider='$PROVIDER', limit=years)
        output['balance_sheet'] = process_balance_sheet(balance_data)
    
    if statement in ['cash', 'all']:
        cash_data = obb.equity.fundamental.cash(symbol=symbol, provider='$PROVIDER', limit=years)
        output['cash_flow'] = process_cash_flow(cash_data, income_data)
    
    print(json.dumps(output, indent=2))
except Exception as e:
    print(json.dumps({"error": str(e), "symbol": symbol}))
    sys.exit(1)
PYSCRIPT
