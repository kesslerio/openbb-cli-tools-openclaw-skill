#!/usr/bin/env bash
# OpenBB financial ratios tool
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
# shellcheck source=/dev/null
source "$SCRIPT_DIR/_openbb_common.sh"


if [ $# -lt 1 ]; then
    echo "Usage: openbb-ratios SYMBOL [provider]"
    exit 1
fi

SYMBOL="$1"
PROVIDER="$(resolve_openbb_provider "${2:-}")"
run_openbb_python_with_retry << PYTHON
from openbb import obb
import json
import sys

symbol = "$SYMBOL"

def safe_get(obj, attr, default=None):
    if obj is None:
        return default
    if hasattr(obj, 'model_extra') and obj.model_extra:
        return obj.model_extra.get(attr, default)
    return getattr(obj, attr, default)

try:
    result = obb.equity.fundamental.metrics(symbol=symbol, provider='$PROVIDER')
    if not result or not result.results:
        print(json.dumps({"error": "No data found", "symbol": symbol}))
        sys.exit(1)
    
    data = result.results[0]
    
    output = {
        "symbol": symbol,
        "pe_ratio": safe_get(data, 'pe_ratio'),
        "forward_pe": safe_get(data, 'forward_pe'),
        "profit_margin": safe_get(data, 'profit_margin'),
        "return_on_equity": safe_get(data, 'return_on_equity'),
        "debt_to_equity": safe_get(data, 'debt_to_equity'),
        "current_ratio": safe_get(data, 'current_ratio'),
    }
    
    print(json.dumps(output, indent=2))

except Exception as e:
    print(json.dumps({"error": str(e), "symbol": symbol}))
    sys.exit(1)
PYTHON
