#!/usr/bin/env bash
# OpenBB stock quote wrapper for clawdbot (NixOS-compatible) - Multi-ticker support

set -euo pipefail

if [ $# -lt 1 ]; then
    echo "Usage: openbb-quote SYMBOL [SYMBOL2 ...] [provider]"
    exit 1
fi

# Set library path for NixOS
LIBSTDCXX=$(nix-build -E "with import <nixpkgs> {}; stdenv.cc.cc.lib" --no-out-link 2>/dev/null)/lib
LIBZ=$(nix-build -E "with import <nixpkgs> {}; zlib" --no-out-link 2>/dev/null)/lib
export LD_LIBRARY_PATH="$LIBSTDCXX:$LIBZ:${LD_LIBRARY_PATH:-}"
export ALPHAVANTAGE_API_KEY="${ALPHAVANTAGE_API_KEY:-0QQ0NV9R8E5I28UI}"

# Detect provider: if last arg is a valid provider, use it
PROVIDER="yfinance"
TICKERS=()

for arg in "$@"; do
    case "$arg" in
        fmp|intrinio|yfinance)
            PROVIDER="$arg"
            ;;
        *)
            TICKERS+=("$arg")
            ;;
    esac
done

# Export for Python
export _OPENBB_PROVIDER="$PROVIDER"
export _OPENBB_TICKERS="$(printf '%s\n' "${TICKERS[@]}")"

# Retry knobs (handles transient OpenBB package build lock contention)
MAX_ATTEMPTS="${OPENBB_RETRY_MAX_ATTEMPTS:-6}"
BASE_DELAY_SEC="${OPENBB_RETRY_BASE_DELAY_SEC:-2}"

is_lock_contention() {
    local text="$1"
    [[ "$text" == *".build.lock"* ]] \
        || [[ "$text" == *"Another build process is running"* ]] \
        || [[ "$text" == *"BlockingIOError"* ]] \
        || [[ "$text" == *"Resource temporarily unavailable"* ]]
}

run_openbb_quote_once() {
    # Use venv's python with full OpenBB SDK
    /home/art/.local/venvs/openbb/bin/python3 << 'PYTHON'
from openbb import obb
import json
import os

PROVIDER = os.environ.get('_OPENBB_PROVIDER', 'yfinance')
TICKERS = [t.strip().upper() for t in os.environ.get('_OPENBB_TICKERS', '').split('\n') if t.strip()]

results = []
for symbol in TICKERS:
    if not symbol:
        continue
    try:
        result = obb.equity.price.quote(symbol=symbol, provider=PROVIDER)
        if result.results:
            data = result.results[0]
            results.append({
                "symbol": symbol,
                "price": float(data.last_price) if data.last_price is not None else None,
                "open": float(data.open) if hasattr(data, 'open') and data.open is not None else None,
                "high": float(data.high) if hasattr(data, 'high') and data.high is not None else None,
                "low": float(data.low) if hasattr(data, 'low') and data.low is not None else None,
                "volume": int(data.volume) if hasattr(data, 'volume') and data.volume is not None else None,
                "prev_close": float(data.prev_close) if hasattr(data, 'prev_close') and data.prev_close is not None else None,
                "change": float(data.change) if hasattr(data, 'change') and data.change is not None else None,
                "change_percent": float(data.change_percent) if hasattr(data, 'change_percent') and data.change_percent is not None else None
            })
    except Exception as e:
        results.append({"symbol": symbol, "error": str(e)})

print(json.dumps(results, indent=2))
PYTHON
}

attempt=1
while true; do
    output=""
    status=0

    if output="$(run_openbb_quote_once 2>&1)"; then
        status=0
    else
        status=$?
    fi

    if [ "$status" -eq 0 ]; then
        printf "%s\n" "$output"
        exit 0
    fi

    if is_lock_contention "$output"; then
        if [ "$attempt" -ge "$MAX_ATTEMPTS" ]; then
            {
                echo "openbb-quote failed after ${MAX_ATTEMPTS} lock-contention retries."
                echo "$output"
            } >&2
            exit "$status"
        fi

        delay=$((BASE_DELAY_SEC * (2 ** (attempt - 1))))
        echo "openbb-quote: build lock detected, retry ${attempt}/${MAX_ATTEMPTS} in ${delay}s..." >&2
        sleep "$delay"
        attempt=$((attempt + 1))
        continue
    fi

    printf "%s\n" "$output" >&2
    exit "$status"
done
