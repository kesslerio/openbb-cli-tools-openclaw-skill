#!/usr/bin/env bash
# OpenBB key metrics tool - P/E, margins, ROE, EPS, etc.
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
source "$SCRIPT_DIR/_openbb_common.sh"


if [ $# -lt 1 ]; then
    echo "Usage: openbb-metrics SYMBOL"
    exit 1
fi

SYMBOL="$1"

# Set library path for NixOS
# Use venv's python directly
run_openbb_python_with_retry << PYTHON
from openbb import obb
import json

symbol = "$SYMBOL"

try:
    # Get key metrics
    result = obb.equity.fundamental.metrics(symbol=symbol, provider='yfinance')
    
    if not result.results:
        print(json.dumps({"error": "No metrics data found"}))
        exit(1)
    
    data = result.results[0]
    
    # Extract key metrics
    output = {
        "symbol": symbol,
        "market_cap": getattr(data, 'market_cap', None),
        "pe_ratio": getattr(data, 'pe_ratio', None),
        "forward_pe": getattr(data, 'forward_pe', None),
        "peg_ratio": getattr(data, 'peg_ratio', None),
        "price_to_book": getattr(data, 'price_to_book', None),
        "price_to_sales": getattr(data, 'price_to_sales', None),
        "enterprise_value": getattr(data, 'enterprise_value', None),
        "ev_to_ebitda": getattr(data, 'ev_to_ebitda', None),
        "ev_to_revenue": getattr(data, 'ev_to_revenue', None),
        "profit_margin": getattr(data, 'profit_margin', None),
        "operating_margin": getattr(data, 'operating_margin', None),
        "return_on_assets": getattr(data, 'return_on_assets', None),
        "return_on_equity": getattr(data, 'return_on_equity', None),
        "revenue": getattr(data, 'revenue', None),
        "revenue_per_share": getattr(data, 'revenue_per_share', None),
        "earnings_per_share": getattr(data, 'earnings_per_share', None),
        "book_value_per_share": getattr(data, 'book_value_per_share', None),
        "current_ratio": getattr(data, 'current_ratio', None),
        "debt_to_equity": getattr(data, 'debt_to_equity', None)
    }
    
    print(json.dumps(output, indent=2))
    
except Exception as e:
    print(json.dumps({"error": str(e)}))
    exit(1)
PYTHON
